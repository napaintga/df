<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cypress Secure Image: Implementation Overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen_style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://www.cypress.com/"><img alt="Logo" src="cypress_logo.png"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Cypress Secure Image
   &#160;<span id="projectnumber">1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('page_secure_image_implementation.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Implementation Overview </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The anatomy of the secure image implementation consists of the following parts.</p>
<h1><a class="anchor" id="group_secure_image_secureboot"></a>
Secure Boot</h1>
<p>The secure boot process entails preserving the chain of trust from the root of trust (Cypress ROM code) to the user application. When the device is transitioned to SECURE lifecycle, the ROM boot will verify the validity of Flash boot. The Flash boot code will then validate the first user application (secure_image) defined in TOC2. The secure image is then used to validate the second user application (user_app0) in TOC2.</p>
<p>The validation of both first and second user applications use the same encryption/decryption scheme (RSASSA-2048). Note that the security method for validating the second image does not need to be RSASSA-2048. It is only required for the first user application.</p>
<h1><a class="anchor" id="group_secure_image_syscall"></a>
System Calls</h1>
<p>System calls are special routines that execute out of ROM. These requests must be made via IPC notifications to the CM0+ core. A secure device may need to limit the allowed requests and therefore a system call parsing routine is included in the secure image. The system call routine is structured to execute in an ISR but it can also be readily moved out to an RTOS task. Few notes on the implementation:</p>
<ol type="1">
<li>System calls that may potentially be dangerous in a secure device are disallowed.</li>
<li>System calls that are Cypress internal or irrelevant to the application are disallowed.</li>
<li>IPC_STRUCT.DATA is checked against a user-defined blacklist to determine whether the request is acceptable. Additionally some requests check against the client's protection context value.</li>
</ol>
<h2><a class="anchor" id="group_secure_image_flash"></a>
Notes on Flash Erase/Program/Write</h2>
<p>The secure image does not support non-blocking Flash erase, program and write requests. These requests rely on complex NMI connections executed out of ROM. However note that in the secure image, the CM0+ is interruptible during the "blocking" operation as it is not executed out of the NMI. Therefore it is not truly blocking. The "user_app0" project's build settings include a preprocessor macro named CY_FLASH_RWW_DRV_SUPPORT_DISABLED to disable the non-blocking Flash write.</p>
<p>To use Flash operations with the System Call routine in the secure image, there are two methods of initiating a blocking operation:</p>
<ol type="1">
<li>Initiate a blocking erase/program/write operation from the CM4 core. This will block the CM4 and the CM0+ cores, but the CM0+ will be interruptible. If this is the desired mode of operation, then the ISR servicing the CM0+ interrupt should be executed out of SRAM. Reads and execution from Flash is not allowed during the Flash erase/program/write operations.</li>
<li>Initiate a blocking erase/program/write operation from the CM0+ core. This will only block the CM0+ core but it will still be interruptible. As with method#1, any ISR servicing an interrupt during this operation must execute out of SRAM. Additionally the CM4 should not read or execute out of Flash during this time. Recommendation is to use an IPC to signal the CM4 of the CM0+ core's intention to perform a Flash modification operation. This can allow the CM4 to transition execution to SRAM or take other appropriate measures to not read or execute out of Flash.</li>
</ol>
<p>For additional information on the Flash erase, program and write operations, refer to the Flash driver documentation and the TRM.</p>
<p>If the non-blocking Flash operations are critical for the application, the System Call routine in the secure image can be performed in another proxy layer. For example another IPC channel can be used by the CM4 to request the CM0+ to perform system calls. This request can be examined by the CM0+ core (as in the System Call routine in the secure image) and then the request can be initiated by the CM0+ core by calling the appropriate API functions (e.g. Flash driver functions). In this system, the IPC channel that would have been directly used by the CM4 to perform Flash writes would be protected to only allow PC=0 to write to them. Hence the CM4 would not have direct access to System Calls.</p>
<h1><a class="anchor" id="group_secure_image_crypto"></a>
Crypto Server</h1>
<p>The Crypto server and the entire Crypto library are included in the secure image. This provides a way for non-secure bus masters to request the secure image to perform Crypto operations in a secure environment via IPC notifications. The crypto routine is structured to execute in an ISR but it can also be readily moved out to an RTOS task. Note that the IPC_STRUCT.DATA is examined against a blacklist to determine if the request is acceptable.</p>
<h1><a class="anchor" id="group_secure_image_prot"></a>
Protection Units</h1>
<p>Protection unit settings are implemented to support the security policy described in the general overview section. Few notes on the implementation:</p>
<ol type="1">
<li>Only CM0+ and the Crypto cores are allowed to operate at PC=0. These should never transition to PC!=0 values. DW0 and DW1 bus masters inherit the PC value of the bus master that configured them. It is not recommended to use the CM0+ to configure these as they would then operate at PC=0.</li>
<li>SMPU slaves are configured to protect sensitive memory regions and only allow PC=0 bus masters to access them. All invalid accesses will generate bus faults.</li>
<li>PPU slaves are configured to protect sensitive peripheral MMIO registers. Depending on the use-case, these are either protected to only allow PC=0 bus masters to access them or give read-only privileges to PC!=0 bus masters.</li>
<li>All SMPU and Programmable PPU master structs are enabled to only allow PC=0 bus masters to reconfigure them. This is to prevent unconfigured slave structs to be used for denial-of-service attacks by compromised down-stream applications.</li>
<li>Master structs of PPUs that have higher priority than the configured PPUs are enabled to only allow PC=0 bus masters to reconfigure them. This is to prevent the slave structs from being reconfigured by compromised applications, which can potentially lead to protection settings override.</li>
<li>Relevant IPC-related protection units are configured to allow all accesses. These are meant to serve as a pointer to what is required by the end user. These should be reconfigured to suit the IPC protection strategy that suits the user-defined security application.</li>
<li>The following slave structs are reserved and used by SROM and FLASHBOOT to protect key resources. The restrictions are configured to only allow PC=0 bus masters to have access.<ul>
<li>SMPU 15: Read/write restriction for ROM private stack.</li>
<li>SMPU 14: Read/write restriction for ROM region.</li>
<li>PROG PPU 15: Write restriction for CPUSS AP_CTL, PROTECTION, CM0_NMI_CTL, DP_CTL and MBIST_CTL registers.</li>
<li>PROG PPU 14: Read/write restriction for CPUSS WOUNDING and CM0_PC0_HANDLER registers.</li>
<li>PROG PPU 13: Write restriction for FlashC FM_CTL.BOOKMARK register.</li>
<li>PROG PPU 12: Read/write restriction for EFUSE region (excluding CUSTOMER_DATA).</li>
<li>PROG PPU 11: Write restriction for IPC 0, 1 and 2 during system calls.</li>
<li>PROG PPU 10: Read/write restriction for Crypto during system calls that use crypto operations.</li>
<li>PROG PPU 9: Read/write restriction for FM_CTL registers. </li>
</ul>
</li>
</ol>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part
<div id="nav-path" class="navpath">
    <ul>
        <li class="footer">
            Generated for <b>Cypress Secure Image</b> by <b>Cypress Semiconductor Corporation</b>.
            All rights reserved.
        </li>
    </ul>
</div>
-->
</body>
</html>
