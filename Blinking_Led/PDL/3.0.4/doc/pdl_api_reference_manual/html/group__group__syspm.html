<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cypress Peripheral Driver Library (PDL): System Power Management (SysPm)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen_style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://www.cypress.com/"><img alt="Logo" src="cypress_logo.png"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Cypress Peripheral Driver Library (PDL)
   &#160;<span id="projectnumber">Version 3.0.4.57</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__group__syspm.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#groups">API Reference</a>  </div>
  <div class="headertitle">
<div class="title">System Power Management (SysPm)</div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">General Description</h2>
<p>Use the System Power Management (SysPm) driver to enter low-power modes and reduce system power consumption in power sensitive designs. </p>
<p>For multi-core devices, this library allows you to individually enter low-power modes for each core.</p>
<p>This document contains the following topics:</p>
<ul>
<li><a class="el" href="group__group__syspm.html#group_syspm_power_modes">Power Modes</a></li>
<li><a class="el" href="group__group__syspm.html#group_syspm_device_power_modes">Device Power Modes</a><ul>
<li><a class="el" href="group__group__syspm.html#group_syspm_switching_into_lpactive">Switching Device into LPActive</a></li>
<li><a class="el" href="group__group__syspm.html#group_syspm_switching_from_lpactive">Switching Device from LPActive</a></li>
<li><a class="el" href="group__group__syspm.html#group_syspm_switching_into_sleep_deepsleep">Switching Device or Core to Sleep or Deep Sleep</a></li>
<li><a class="el" href="group__group__syspm.html#group_syspm_wakingup_from_sleep_deepsleep">Waking Up from Sleep or Deep Sleep</a></li>
<li><a class="el" href="group__group__syspm.html#group_syspm_switching_into_hibernate">Switching Device to Hibernate</a></li>
<li><a class="el" href="group__group__syspm.html#group_syspm_wakingup_from_hibernate">Waking Up from Hibernate</a></li>
</ul>
</li>
<li><a class="el" href="group__group__syspm.html#group_syspm_managing_core_regulators">Managing Core Voltage Regulators</a><ul>
<li><a class="el" href="group__group__syspm.html#group_syspm_ulp_limitations">ULP Limitations</a></li>
<li><a class="el" href="group__group__syspm.html#group_syspm_lp_limitations">LP Limitations</a></li>
</ul>
</li>
<li><a class="el" href="group__group__syspm.html#group_syspm_managing_pmic">Managing PMIC</a></li>
<li><a class="el" href="group__group__syspm.html#group_syspm_managing_backup_domain">Managing the Backup Domain</a></li>
<li><a class="el" href="group__group__syspm.html#group_syspm_cb">SysPm Callbacks</a><ul>
<li><a class="el" href="group__group__syspm.html#group_syspm_cb_example">SysPm Callbacks Example</a></li>
<li><a class="el" href="group__group__syspm.html#group_syspm_cb_config_consideration">Callback Configuration Considerations</a><ul>
<li><a class="el" href="group__group__syspm.html#group_syspm_cb_parameters">Callback Function Parameters</a></li>
<li><a class="el" href="group__group__syspm.html#group_syspm_cb_structures">Callback Function Structure</a></li>
<li><a class="el" href="group__group__syspm.html#group_syspm_cb_function_implementation">Callback Function Implementation</a></li>
<li><a class="el" href="group__group__syspm.html#group_syspm_cb_flow">Callbacks Execution Flow</a></li>
<li><a class="el" href="group__group__syspm.html#group_syspm_cb_uregistering">Callback Unregistering</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="el" href="group__group__syspm.html#group_syspm_definitions">Definitions</a></li>
</ul>
<h1><a class="anchor" id="group_syspm_section_configuration"></a>
Configuration Considerations</h1>
<h2><a class="anchor" id="group_syspm_power_modes"></a>
Power Modes</h2>
<p>PSoC 6 MCUs support the following power modes (in the order of high-to-low power consumption): Active, Low-Power (LPActive), Deep Sleep, and Hibernate. The core(s) can also be in Arm-defined power modes - Active, Sleep, and Deep Sleep.</p>
<h2><a class="anchor" id="group_syspm_device_power_modes"></a>
Device Power Modes</h2>
<ul>
<li><b>Active</b> - In this mode the code is executed, and all logic and memories are powered. Firmware may disable clocks for specific peripherals and power down specific analog power domains.</li>
<li><b>LPActive</b> - Low-Power mode is like Active mode, but with clock restrictions and limited/slower peripherals to achieve a lower system current. Refer to <a class="el" href="group__group__syspm.html#group_syspm_switching_into_lpactive">Switching Device into LPActive</a> in Configuration considerations.</li>
<li><b>Deep Sleep</b> - is a lower power mode where high-frequency clocks are disabled. Deep-Sleep-capable peripherals are available. A normal wakeup from Deep Sleep returns to either LPActive, Active, or Sleep, depending on the previous state and programmed behavior for the configured wakeup interrupt. Likewise, a debug wakeup from Deep Sleep returns to Sleep, depending on which mode was used to enter the Deep Sleep power mode.</li>
<li><b>Hibernate</b> - is an even lower power mode that is entered from firmware, just like Deep Sleep. However, on a wakeup the core and all peripherals go through a full reset. The I/O's state is frozen so that the output driver state is held. Note that in this mode, the core(s) and all peripherals lose their states, so the system and firmware reboot on a wakeup event. Backup memory (if present) can be used to store system states for use on the next reboot.</li>
</ul>
<h3><a class="anchor" id="group_syspm_switching_into_lpactive"></a>
Switching Device into LPActive</h3>
<p>Before switching into the LPActive power mode, ensure that the device meets the current load limitation. Decrease the clock frequencies, and slow or disable peripherals. Refer to the <a class="el" href="group__group__syspm.html#group_syspm_managing_core_regulators">Managing Core Voltage Regulators</a> Section. <br />
</p><ul>
<li>The IMO is set to the Clk_HF</li>
<li>Turn off unused peripherals, or decrease their operating frequencies to achieve total current consumption less than or equal to 20 mA.</li>
<li>Call the <a class="el" href="group__group__syspm__functions__power.html#ga8ff9480e354c01a80b2597b1c16d8126" title="This function switches only the supply regulators into Low Power mode. ">Cy_SysPm_EnterLowPowerMode()</a> function that will put references such as POR and BOD into Low-Power mode.</li>
<li>If the core is sourced by the LDO Core Voltage Regulator, then the 0.9 V (nominal) mode must be set. Refer <a class="el" href="group__group__syspm__functions__ldo.html">LDO</a> API in <a class="el" href="group__group__syspm__functions__core__regulators.html">Core Voltage Regulation</a>.</li>
<li>If the core is sourced by the Buck Core Voltage Regulator, then it is recommended, but not required, to set CY_SYSPM_BUCK_OUT1_VOLTAGE_0_9V. Decide whether your application can meet the requirements for the CY_SYSPM_BUCK_OUT1_VOLTAGE_0_9V. See <a class="el" href="group__group__syspm.html#group_syspm_managing_core_regulators">Managing Core Voltage Regulators</a>.</li>
</ul>
<h3><a class="anchor" id="group_syspm_switching_from_lpactive"></a>
Switching Device from LPActive</h3>
<p>To switch a device from LPActive to Active mode, just call <a class="el" href="group__group__syspm__functions__power.html#gae2d2dd20ca4ec0e37915c5883fe9db1d" title="Exits the device from Low Power mode. ">Cy_SysPm_ExitLowPowerMode()</a>.</p>
<h3><a class="anchor" id="group_syspm_switching_into_sleep_deepsleep"></a>
Switching Device or Core to Sleep or Deep Sleep</h3>
<p>For multi-core devices, the <a class="el" href="group__group__syspm__functions__power.html#ga4f9e1d22b5e0222f052c017cbe8a10d3" title="Sets a CPU core to Sleep mode. ">Cy_SysPm_Sleep()</a> and <a class="el" href="group__group__syspm__functions__power.html#ga1211c6447be4863cb7ca807e2c9f98ee" title="Sets a CPU core to the Deep Sleep mode. ">Cy_SysPm_DeepSleep()</a> functions switch only the core that calls the function into the Sleep or the Deep Sleep power mode. To set the whole device in the Sleep or Deep Sleep power mode, ensure that each core calls the <a class="el" href="group__group__syspm__functions__power.html#ga4f9e1d22b5e0222f052c017cbe8a10d3" title="Sets a CPU core to Sleep mode. ">Cy_SysPm_Sleep()</a> or <a class="el" href="group__group__syspm__functions__power.html#ga1211c6447be4863cb7ca807e2c9f98ee" title="Sets a CPU core to the Deep Sleep mode. ">Cy_SysPm_DeepSleep()</a> function.</p>
<p>There are situations when the device does not switch into the Deep Sleep power mode immediately after the second core calls <a class="el" href="group__group__syspm__functions__power.html#ga1211c6447be4863cb7ca807e2c9f98ee" title="Sets a CPU core to the Deep Sleep mode. ">Cy_SysPm_DeepSleep()</a>. The device will switch into Deep Sleep mode automatically a little bit later, after the low-power circuits are ready to switch into Deep Sleep. Refer to the <a class="el" href="group__group__syspm__functions__power.html#ga1211c6447be4863cb7ca807e2c9f98ee" title="Sets a CPU core to the Deep Sleep mode. ">Cy_SysPm_DeepSleep()</a> description for more details.</p>
<p>All pending interrupts should be cleared before the device is put into a Sleep or Deep Sleep mode, even if they are masked.</p>
<p>For single-core devices, SysPm functions that return the status of the unsupported core always return CY_SYSPM_STATUS_&lt;CORE&gt;_DEEPSLEEP.</p>
<h3><a class="anchor" id="group_syspm_wakingup_from_sleep_deepsleep"></a>
Waking Up from Sleep or Deep Sleep</h3>
<p>For Arm-based devices, an interrupt is required for the core to wake up. For multi-core devices, one core can wake up the other core by sending the event instruction. Use the CMSIS function __SEV() to sent event from one core to another.</p>
<h3><a class="anchor" id="group_syspm_switching_into_hibernate"></a>
Switching Device to Hibernate</h3>
<p>If you call <a class="el" href="group__group__syspm__functions__power.html#ga2929e98b966d58c9246108a767ed7f53" title="Sets the device into Hibernate mode. ">Cy_SysPm_Hibernate()</a> from either core, the device will be switched into the Hibernate power mode directly, as there is no handshake between cores.</p>
<h3><a class="anchor" id="group_syspm_wakingup_from_hibernate"></a>
Waking Up from Hibernate</h3>
<p>The system can wake up from Hibernate mode by configuring:</p>
<ul>
<li>Wakeup pin</li>
<li>LP Comparator</li>
<li>RTC alarm</li>
<li>WDT interrupt</li>
</ul>
<p>Wakeup is supported from device specific pin(s) with programmable polarity. Additionally, unregulated peripherals can wake the device under some conditions. For example, a low-power comparator can wake the device by comparing two external voltages but may not support comparison to an internally-generated voltage. The Backup domain remains functional, and if present it can schedule an alarm to wake the device from Hibernate using RTC. Alternatively, the Watchdog Timer (WDT) can be configured to wake-up the device by WDT interrupt. Refer to <a class="el" href="group__group__syspm__functions__power.html#ga2540970e6c27efa25752efc43da0d622">Cy_SysPm_SetHibernateWakeupSource()</a> for more details.</p>
<h2><a class="anchor" id="group_syspm_managing_core_regulators"></a>
Managing Core Voltage Regulators</h2>
<p>The SysPm driver provides functionality to manage the power modes of the low-dropout (LDO) and Buck Core Voltage Regulators. For both core regulators, two voltages are possible:</p>
<ul>
<li><b>0.9 V (nominal)</b> - core is sourced by 0.9 V (nominal). This core regulator power mode is called Ultra Low-Power (ULP). In this mode, the device functionality and performance is limited. You must decrease the operating frequency and current consumption to meet the <a class="el" href="group__group__syspm.html#group_syspm_ulp_limitations">ULP Limitations</a>, shown below.</li>
<li><b>1.1 V (nominal)</b> - core is sourced by 1.1 V (nominal). This core regulator power mode is called low-power mode (LP). In this mode, you must meet the <a class="el" href="group__group__syspm.html#group_syspm_lp_limitations">LP Limitations</a>, shown below.</li>
</ul>
<h3><a class="anchor" id="group_syspm_ulp_limitations"></a>
ULP Limitations</h3>
<p>When the core voltage is <b>0.9 V (nominal)</b> the next limitations must be meet: <br />
</p><ul>
<li>the maximum operating frequency for all Clk_HF paths must not exceed <b>50 MHz</b>, whereas the peripheral and slow clock must not exceed <b>25 MHz</b> (refer to <a class="el" href="group__group__sysclk.html">System Clock (SysClk)</a> driver documentation).</li>
<li>the total current consumption must be less than or equal to <b>20 mA</b><br />
</li>
</ul>
<h3><a class="anchor" id="group_syspm_lp_limitations"></a>
LP Limitations</h3>
<p>When the core voltage is <b>1.1V (nominal)</b> the next limitations must be meet:</p><ul>
<li>the maximum operating frequency for all Clk_HF paths must not exceed <b>150 MHz</b>, whereas the peripheral and slow clock must not exceed <b>100 MHz</b> (refer to <a class="el" href="group__group__sysclk.html">System Clock (SysClk)</a> driver documentation). <br />
</li>
<li>the total current consumption must be less than or equal to <b>250 mA</b></li>
</ul>
<h2><a class="anchor" id="group_syspm_managing_pmic"></a>
Managing PMIC</h2>
<p>The SysPm driver also provides an API to configure the external power management integrated circuit (PMIC) that supplies Vddd. Use the API to enable the PMIC output that is routed to pmic_wakeup_out pin, and configure the polarity of the PMIC input (pmic_wakeup_in) that is used to wake up the PMIC.</p>
<p>The PMIC is automatically enabled when:</p>
<ul>
<li>the PMIC is locked by a call to <a class="el" href="group__group__syspm__functions__pmic.html#ga3b7c5543e23fca7c76cc46b3f2ef0f6a" title="Locks the PMIC control register so that no changes can be made. ">Cy_SysPm_PmicLock()</a></li>
<li>the configured polarity of the PMIC input and the polarity driven to pmic_wakeup_in pin matches.</li>
</ul>
<p>Because a call to <a class="el" href="group__group__syspm__functions__pmic.html#ga3b7c5543e23fca7c76cc46b3f2ef0f6a" title="Locks the PMIC control register so that no changes can be made. ">Cy_SysPm_PmicLock()</a> automatically enables the PMIC, the PMIC can remain disabled only when it is unlocked. See <a class="el" href="group__group__syspm__functions__pmic.html#ga96284454a0d47d45fcfcde8d506e7d54" title="Unlocks the PMIC control register so that changes can be made. ">Cy_SysPm_PmicUnlock()</a> for more details.</p>
<p>Use <a class="el" href="group__group__syspm__functions__pmic.html#gaa5b92e48634f53796dba77ec022bfbe3" title="Returns the PMIC lock status. ">Cy_SysPm_PmicIsLocked()</a> to read the current PMIC lock status.</p>
<p>To enable the PMIC, use these functions in this order:<br />
 </p><div class="fragment"><div class="line">1 <a class="code" href="group__group__syspm__functions__pmic.html#ga96284454a0d47d45fcfcde8d506e7d54">Cy_SysPm_PmicUnlock</a>();</div><div class="line">2 <a class="code" href="group__group__syspm__functions__pmic.html#ga7ff249e20d809dbab4ea05c7c2dd32d0">Cy_SysPm_PmicEnable</a>();</div><div class="line">3 <a class="code" href="group__group__syspm__functions__pmic.html#ga3b7c5543e23fca7c76cc46b3f2ef0f6a">Cy_SysPm_PmicLock</a>();</div></div><!-- fragment --><p>To disable the PMIC block, unlock the PMIC. Then call <a class="el" href="group__group__syspm__functions__pmic.html#gaf684eba727f72e7312081a5a98a7bc4f" title="Disables the PMIC. ">Cy_SysPm_PmicDisable()</a> with the inverted value of the current active state of the pmic_wakeup_in pin. For example, assume the current state of the pmic_wakeup_in pin is active low. To disable the PMIC, call these functions in this order:<br />
 </p><div class="fragment"><div class="line">1 <a class="code" href="group__group__syspm__functions__pmic.html#ga96284454a0d47d45fcfcde8d506e7d54">Cy_SysPm_PmicUnlock</a>();</div><div class="line">2 <a class="code" href="group__group__syspm__functions__pmic.html#gaf684eba727f72e7312081a5a98a7bc4f">Cy_SysPm_PmicDisable</a>(<a class="code" href="group__group__syspm__data__enumerates.html#ggac8cae3aa3e15bb4ce9e737fdaf5027fcad632c1c3db90572755db24b8cf14b4ff">CY_SYSPM_PMIC_POLARITY_HIGH</a>);</div></div><!-- fragment --><p> Note that you do not call <a class="el" href="group__group__syspm__functions__pmic.html#ga3b7c5543e23fca7c76cc46b3f2ef0f6a" title="Locks the PMIC control register so that no changes can be made. ">Cy_SysPm_PmicLock()</a>, because that automatically enables the PMIC.</p>
<p>While disabled, the PMIC block is automatically enabled when the pmic_wakeup_in pin state is changed into high state.</p>
<p>To disable the PMIC output, call these functions in this order: <a class="el" href="group__group__syspm__functions__pmic.html#ga96284454a0d47d45fcfcde8d506e7d54" title="Unlocks the PMIC control register so that changes can be made. ">Cy_SysPm_PmicUnlock()</a>; <a class="el" href="group__group__syspm__functions__pmic.html#ga163465650a9194c4fe636cf8291eea25" title="Disables the PMIC output. ">Cy_SysPm_PmicDisableOutput()</a>;</p>
<p>Do not call <a class="el" href="group__group__syspm__functions__pmic.html#ga3b7c5543e23fca7c76cc46b3f2ef0f6a" title="Locks the PMIC control register so that no changes can be made. ">Cy_SysPm_PmicLock()</a> (which automatically enables the PMIC output).</p>
<p>When disabled, the PMIC output is enabled when the PMIC is locked, or by calling <a class="el" href="group__group__syspm__functions__pmic.html#ga619436ec53b8c7ef510180f25588061b" title="Enables the PMIC output. ">Cy_SysPm_PmicEnableOutput()</a>.</p>
<h2><a class="anchor" id="group_syspm_managing_backup_domain"></a>
Managing the Backup Domain</h2>
<p>The SysPm driver provide functions to:</p>
<ul>
<li>Configure supercapacitor charge</li>
<li>Select power supply (Vbackup or Vddd) for the Vddbackup</li>
<li>Measure Vddbackup using the ADC</li>
</ul>
<p>Refer to the <a class="el" href="group__group__syspm__functions__backup.html">Backup Domain</a> functions for more details.</p>
<h2><a class="anchor" id="group_syspm_cb"></a>
SysPm Callbacks</h2>
<p>The SysPm driver handles the low power callbacks declared in the application.</p>
<p>If there are no callbacks registered, the device just executes the power mode transition. However, it is often the case that your firmware must prepare for low power mode. For example, you may need to disable a peripheral, or ensure that a message is not being transmitted or received.</p>
<p>To enable this, the SysPm driver implements a callback mechanism. When a lower power mode transition is about to take place (either entering or exiting <a class="el" href="group__group__syspm.html#group_syspm_device_power_modes">Device Power Modes</a>), the registered callbacks are called.</p>
<p>The SysPm driver organizes all the callbacks into a linked list. While entering a low-power mode, SysPm goes through that linked list from first to last, executing the callbacks one after another. While exiting low-power mode, SysPm goes through that linked list again, but in the opposite direction from last to first.</p>
<p>For example, the picture below shows three callback structures organized into a linked list: myDeepSleep1, mySleep1, myDeepSleep2 (represented with the <a class="el" href="structcy__stc__syspm__callback__t.html">cy_stc_syspm_callback_t</a> configuration structure). Each structure contains, among other fields, the address of the callback function. The code snippets below set this up so that myDeepSleep1 is called first when entering the low-power mode. This also means that myDeepSleep1 will be the last one to execute when exiting the low-power mode.</p>
<p>The callback structures after registration: </p><div class="image">
<img src="syspm_2_10_after_registration.png" alt="syspm_2_10_after_registration.png"/>
</div>
<p>Your application must register each callback, so that SysPm can execute it. Upon registration, the linked list is built by the SysPm driver. Notice the &amp;mySleep1 address in the myDeepSleep1 <a class="el" href="structcy__stc__syspm__callback__t.html">cy_stc_syspm_callback_t</a> structure. This is filled in by the SysPm driver when you register mySleep1. The order in which the callbacks are registered in the application defines the order of their execution by the SysPm driver. You may have up to 32 callback functions registered. Call <a class="el" href="group__group__syspm__functions__callback.html#ga0d58b00c8dc764a6371590f70e2f73c7">Cy_SysPm_RegisterCallback()</a> to register each callback function.</p>
<p>A callback function is typically associated with a particular driver that handles the peripheral. So the callback mechanism enables a peripheral to prepare for a low-power mode (for instance, shutting down the analog part); or to perform tasks while exiting a low-power mode (like enabling the analog part again).</p>
<p>With the callback mechanism you can prevent switching into a low-power mode if a peripheral is not ready. For example, driver X is in the process of receiving a message. In the callback function implementation simply return CY_SYSPM_FAIL in a response to CY_SYSPM_CHECK_READY.</p>
<p>If success is returned while executing a callback, the SysPm driver calls the next callback and so on to the end of the list. If at some point a callback returns CY_SYSPM_FAIL in response to the CY_SYSPM_CHECK_READY step, all the callbacks that have already executed are executed in reverse order, with the CY_SYSPM_CHECK_FAIL step. This allows each callback to know that entering the low-power mode has failed. The callback can then undo whatever it did to prepare for low power mode. For example, if the driver X callback shut down the analog part, it can re-enable the analog part.</p>
<p>Let's switch to an example explaining the implementation, setup, and registration of three callbacks (myDeepSleep1, mySleep1, myDeepSleep2) in the application. The <a class="el" href="group__group__syspm.html#group_syspm_cb_config_consideration">Callback Configuration Considerations</a> are provided after the <a class="el" href="group__group__syspm.html#group_syspm_cb_example">SysPm Callbacks Example</a>.</p>
<h2><a class="anchor" id="group_syspm_cb_example"></a>
SysPm Callbacks Example</h2>
<p>The following code snippets demonstrate how use the SysPm callbacks mechanism. We will build the prototype for an application that registers three callback functions: <br />
</p><ol type="1">
<li>mySleep1 - handles Sleep <br />
</li>
<li>myDeepSleep1 - handles Deep Sleep and is associated with peripheral HW1_address (see <a href="..\..\pdl_user_guide.pdf">PDL Design</a> section to learn about the base hardware address) <br />
</li>
<li>myDeepSleep2 - handles entering and exiting Deep Sleep and is associated with peripheral HW2_address <br />
</li>
</ol>
<p>We set things up so that the mySleep1 and myDeepSleep1 callbacks do nothing while entering the low power mode (skip on CY_SYSPM_SKIP_BEFORE_TRANSITION - see <a class="el" href="group__group__syspm.html#group_syspm_cb_function_implementation">Callback Function Implementation</a> in <a class="el" href="group__group__syspm.html#group_syspm_cb_config_consideration">Callback Configuration Considerations</a>). Skipping the actions while entering low power might be useful if you need to save the time while switching low-power modes. This is because the callback function with skipped mode is not even called.</p>
<p>Let's first declare the callback functions. Each gets the pointer to the <a class="el" href="structcy__stc__syspm__callback__params__t.html">cy_stc_syspm_callback_params_t</a> structure as the argument.</p>
<div class="fragment"><div class="line"><span class="comment">/* Scenario: there is a need to have one callback handler for Sleep mode and </span></div><div class="line"><span class="comment">* two for the Deep Sleep mode. </span></div><div class="line"><span class="comment">* Sleep SleepFunc1 callback function should skip on </span></div><div class="line"><span class="comment">* CY_SYSPM_BEFORE_TRANSITION mode.</span></div><div class="line"><span class="comment">* DeepSleepFunc1 callback function should skip on CY_SYSPM_BEFORE_TRANSITION </span></div><div class="line"><span class="comment">* mode.</span></div><div class="line"><span class="comment">* DeepSleepFunc2 excutes all four modes. </span></div><div class="line"><span class="comment">*/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment">*  Callbacks prototypes</span></div><div class="line"><span class="comment">******************************************************************************/</span></div><div class="line"><a class="code" href="group__group__syspm__data__enumerates.html#ga601b1cb722cb091133caf33d8ab235ca">cy_en_syspm_status_t</a> SleepFunc1(<a class="code" href="structcy__stc__syspm__callback__params__t.html">cy_stc_syspm_callback_params_t</a> *callbackParams);</div><div class="line"><a class="code" href="group__group__syspm__data__enumerates.html#ga601b1cb722cb091133caf33d8ab235ca">cy_en_syspm_status_t</a> DeepSleepFunc1(<a class="code" href="structcy__stc__syspm__callback__params__t.html">cy_stc_syspm_callback_params_t</a> *callbackParams);</div><div class="line"><a class="code" href="group__group__syspm__data__enumerates.html#ga601b1cb722cb091133caf33d8ab235ca">cy_en_syspm_status_t</a> DeepSleepFunc2(<a class="code" href="structcy__stc__syspm__callback__params__t.html">cy_stc_syspm_callback_params_t</a> *callbackParams);</div></div><!-- fragment --><p> Now we setup the <a class="el" href="structcy__stc__syspm__callback__params__t.html">cy_stc_syspm_callback_params_t</a> structures that we will pass to callback functions. Note that for the myDeepSleep1 and myDeepSleep2 callbacks we also pass the pointers to the peripherals related to that callback (see <a href="..\..\pdl_user_guide.pdf">PDL Design</a> section to learn about the base hardware address). The configuration considerations related to this structure are described in <a class="el" href="group__group__syspm.html#group_syspm_cb_parameters">Callback Function Parameters</a> in <a class="el" href="group__group__syspm.html#group_syspm_cb_config_consideration">Callback Configuration Considerations</a>.</p>
<div class="fragment"><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment">*  Parameters structures for callbacks functions</span></div><div class="line"><span class="comment">******************************************************************************/</span></div><div class="line"><a class="code" href="structcy__stc__syspm__callback__params__t.html">cy_stc_syspm_callback_params_t</a> sleepParam1 = </div><div class="line">{</div><div class="line">    <a class="code" href="group__group__syspm__data__enumerates.html#ggae06cd8869fe61d709ad6145ca9f3cd63ab7ec706d80b347433d0063f2a8115784">CY_SYSPM_CHECK_READY</a>, </div><div class="line">    NULL,</div><div class="line">    NULL</div><div class="line">};</div><div class="line"></div><div class="line"><a class="code" href="structcy__stc__syspm__callback__params__t.html">cy_stc_syspm_callback_params_t</a> deepSleepParam1 = </div><div class="line">{</div><div class="line">    <a class="code" href="group__group__syspm__data__enumerates.html#ggae06cd8869fe61d709ad6145ca9f3cd63ab7ec706d80b347433d0063f2a8115784">CY_SYSPM_CHECK_READY</a>, </div><div class="line">    &amp;HW1_address,</div><div class="line">    &amp;context</div><div class="line">};</div><div class="line"></div><div class="line"><a class="code" href="structcy__stc__syspm__callback__params__t.html">cy_stc_syspm_callback_params_t</a> deepSleepParam2 = </div><div class="line">{</div><div class="line">    <a class="code" href="group__group__syspm__data__enumerates.html#ggae06cd8869fe61d709ad6145ca9f3cd63ab7ec706d80b347433d0063f2a8115784">CY_SYSPM_CHECK_READY</a>, </div><div class="line">    &amp;HW2_address,</div><div class="line">    NULL</div><div class="line">};</div></div><!-- fragment --><p> Now we setup the actual callback configuration structures. Each of these contains, among the other fields, the address of the <a class="el" href="structcy__stc__syspm__callback__params__t.html">cy_stc_syspm_callback_params_t</a> we just set up. We will use the callback configuration structures later in the code to register the callbacks in the SysPm driver. Again, we set things up so that the mySleep1 and myDeepSleep1 callbacks do nothing while entering the low power mode (skip on CY_SYSPM_SKIP_BEFORE_TRANSITION) - see <a class="el" href="group__group__syspm.html#group_syspm_cb_function_implementation">Callback Function Implementation</a> in <a class="el" href="group__group__syspm.html#group_syspm_cb_config_consideration">Callback Configuration Considerations</a>.</p>
<div class="fragment"><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment">*  Callbacks structures</span></div><div class="line"><span class="comment">******************************************************************************/</span></div><div class="line"><a class="code" href="structcy__stc__syspm__callback__t.html">cy_stc_syspm_callback_t</a> mySleep1 = </div><div class="line">{</div><div class="line">    &amp;SleepFunc1, </div><div class="line">    <a class="code" href="group__group__syspm__data__enumerates.html#gga8c2960c0164ead1cfa86e7d6846b6ff0ac8d781c074f372d0b201da4e040a4768">CY_SYSPM_SLEEP</a>,</div><div class="line">    <a class="code" href="group__group__syspm__skip__callback__modes.html#ga77a2dc7326bb7e6cf893dc7b258b3a42">CY_SYSPM_SKIP_BEFORE_TRANSITION</a>,</div><div class="line">    &amp;sleepParam1,</div><div class="line">    NULL,</div><div class="line">    NULL</div><div class="line">};</div><div class="line"></div><div class="line"><a class="code" href="structcy__stc__syspm__callback__t.html">cy_stc_syspm_callback_t</a> myDeepSleep1 = </div><div class="line">{</div><div class="line">    &amp;DeepSleepFunc1, </div><div class="line">    <a class="code" href="group__group__syspm__data__enumerates.html#gga8c2960c0164ead1cfa86e7d6846b6ff0abc51d74deff0ceea4304b01b2d57bd9d">CY_SYSPM_DEEPSLEEP</a>,</div><div class="line">    <a class="code" href="group__group__syspm__skip__callback__modes.html#ga77a2dc7326bb7e6cf893dc7b258b3a42">CY_SYSPM_SKIP_BEFORE_TRANSITION</a>,</div><div class="line">    &amp;deepSleepParam1,</div><div class="line">    NULL,</div><div class="line">    NULL</div><div class="line">};</div><div class="line"></div><div class="line"><a class="code" href="structcy__stc__syspm__callback__t.html">cy_stc_syspm_callback_t</a> myDeepSleep2 = </div><div class="line">{</div><div class="line">    &amp;DeepSleepFunc2, </div><div class="line">    <a class="code" href="group__group__syspm__data__enumerates.html#gga8c2960c0164ead1cfa86e7d6846b6ff0abc51d74deff0ceea4304b01b2d57bd9d">CY_SYSPM_DEEPSLEEP</a>,</div><div class="line">    0U,</div><div class="line">    &amp;deepSleepParam2,</div><div class="line">    NULL,</div><div class="line">    NULL</div><div class="line">};</div><div class="line">    </div></div><!-- fragment --><p> Note that in each case the last two fields are NULL. These are fields used by the SysPm driver to set up the linked list of callback functions.</p>
<p>The callback structures are now defined and allocated in the user's memory space: </p><div class="image">
<img src="syspm_2_10_before_registration.png" alt="syspm_2_10_before_registration.png"/>
</div>
<p>Now we implement the callback functions. See <a class="el" href="group__group__syspm.html#group_syspm_cb_function_implementation">Callback Function Implementation</a> in <a class="el" href="group__group__syspm.html#group_syspm_cb_config_consideration">Callback Configuration Considerations</a> for the instructions on how the callback functions should be implemented.</p>
<div class="fragment"><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment">*  SleepFunc1 implementation</span></div><div class="line"><span class="comment">******************************************************************************/</span></div><div class="line"><a class="code" href="group__group__syspm__data__enumerates.html#ga601b1cb722cb091133caf33d8ab235ca">cy_en_syspm_status_t</a> SleepFunc1(<a class="code" href="structcy__stc__syspm__callback__params__t.html">cy_stc_syspm_callback_params_t</a> *callbackParams)</div><div class="line">{</div><div class="line">    <a class="code" href="group__group__syspm__data__enumerates.html#ga601b1cb722cb091133caf33d8ab235ca">cy_en_syspm_status_t</a> retVal = <a class="code" href="group__group__syspm__data__enumerates.html#gga601b1cb722cb091133caf33d8ab235caa5e406c6cb40fdf6663df0208737d4f11">CY_SYSPM_FAIL</a>;</div><div class="line">    </div><div class="line">    <span class="keywordflow">switch</span>(callbackParams-&gt;<a class="code" href="structcy__stc__syspm__callback__params__t.html#a2737abe860f048be7574b0f95f22e18c">mode</a>)</div><div class="line">    {</div><div class="line">        <span class="comment">/* In this case ensure that firmware/hardware is ready for sleep mode */</span></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__group__syspm__data__enumerates.html#ggae06cd8869fe61d709ad6145ca9f3cd63ab7ec706d80b347433d0063f2a8115784">CY_SYSPM_CHECK_READY</a>:</div><div class="line">            <span class="keywordflow">if</span>(<span class="keyword">true</span><span class="comment">/* system is ready */</span>)</div><div class="line">            {</div><div class="line">                <span class="comment">/* Process the &quot;check ready&quot; condition */</span></div><div class="line">                retVal = <a class="code" href="group__group__syspm__data__enumerates.html#gga601b1cb722cb091133caf33d8ab235caaf00d22f1ee891a8a56f8bbf58132e775">CY_SYSPM_SUCCESS</a>;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        </div><div class="line">        <span class="comment">/* One of the registered callbacks which were executed after this function </span></div><div class="line"><span class="comment">        *  returned CY_SYSPM_FAIL, need to revert changes done in the </span></div><div class="line"><span class="comment">        * CY_SYSPM_CHECK_READY case.</span></div><div class="line"><span class="comment">        */</span></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__group__syspm__data__enumerates.html#ggae06cd8869fe61d709ad6145ca9f3cd63a96acf2d0ae5537798228d5fba0fecd17">CY_SYSPM_CHECK_FAIL</a>:</div><div class="line">            {</div><div class="line">                <span class="comment">/* Revert changes done in the CY_SYSPM_CHECK_READY case */</span></div><div class="line">                retVal = <a class="code" href="group__group__syspm__data__enumerates.html#gga601b1cb722cb091133caf33d8ab235caaf00d22f1ee891a8a56f8bbf58132e775">CY_SYSPM_SUCCESS</a>;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">            </div><div class="line">        <span class="comment">/* This case will be skipped during callbacks execution */</span>    </div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__group__syspm__data__enumerates.html#ggae06cd8869fe61d709ad6145ca9f3cd63a7d302375276b3b5f250a8208c999b558">CY_SYSPM_BEFORE_TRANSITION</a>:</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">            </div><div class="line">        <span class="comment">/* This case is executed after the wakeup from the sleep */</span></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__group__syspm__data__enumerates.html#ggae06cd8869fe61d709ad6145ca9f3cd63aafd1db1f7f86ac7bbd18d59b78af5693">CY_SYSPM_AFTER_TRANSITION</a>:</div><div class="line">            {</div><div class="line">                <span class="comment">/* Make some actions, if required, after the wakeup from the sleep mode */</span></div><div class="line">                retVal = <a class="code" href="group__group__syspm__data__enumerates.html#gga601b1cb722cb091133caf33d8ab235caaf00d22f1ee891a8a56f8bbf58132e775">CY_SYSPM_SUCCESS</a>;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        </div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">    </div><div class="line">    <span class="keywordflow">return</span> (retVal);</div><div class="line">}</div><div class="line"></div><div class="line">    </div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment">*  DeepSleepFunc1 implementation</span></div><div class="line"><span class="comment">******************************************************************************/</span></div><div class="line"><a class="code" href="group__group__syspm__data__enumerates.html#ga601b1cb722cb091133caf33d8ab235ca">cy_en_syspm_status_t</a> DeepSleepFunc1(<a class="code" href="structcy__stc__syspm__callback__params__t.html">cy_stc_syspm_callback_params_t</a> *callbackParams)</div><div class="line">{</div><div class="line">    <a class="code" href="group__group__syspm__data__enumerates.html#ga601b1cb722cb091133caf33d8ab235ca">cy_en_syspm_status_t</a> retVal = <a class="code" href="group__group__syspm__data__enumerates.html#gga601b1cb722cb091133caf33d8ab235caa5e406c6cb40fdf6663df0208737d4f11">CY_SYSPM_FAIL</a>;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span>(callbackParams-&gt;<a class="code" href="structcy__stc__syspm__callback__params__t.html#a2737abe860f048be7574b0f95f22e18c">mode</a>)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Check is the HW1 ready to enter into the deep sleep */</span></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__group__syspm__data__enumerates.html#ggae06cd8869fe61d709ad6145ca9f3cd63ab7ec706d80b347433d0063f2a8115784">CY_SYSPM_CHECK_READY</a>:</div><div class="line">        </div><div class="line">            <span class="comment">/* ... */</span></div><div class="line">        </div><div class="line">            <span class="keywordflow">if</span>(<span class="keyword">true</span><span class="comment">/* HW1 is ready */</span>)</div><div class="line">            {</div><div class="line">                <span class="comment">/* Process the &quot;check ready&quot; condition */</span></div><div class="line">                retVal = <a class="code" href="group__group__syspm__data__enumerates.html#gga601b1cb722cb091133caf33d8ab235caaf00d22f1ee891a8a56f8bbf58132e775">CY_SYSPM_SUCCESS</a>;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        </div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">    </div><div class="line">    <span class="keywordflow">return</span> (retVal);</div><div class="line">}</div><div class="line"></div><div class="line">    </div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment">*  DeepSleepFunc2 implementation</span></div><div class="line"><span class="comment">******************************************************************************/</span></div><div class="line"><a class="code" href="group__group__syspm__data__enumerates.html#ga601b1cb722cb091133caf33d8ab235ca">cy_en_syspm_status_t</a> DeepSleepFunc2(<a class="code" href="structcy__stc__syspm__callback__params__t.html">cy_stc_syspm_callback_params_t</a> *callbackParams)</div><div class="line">{</div><div class="line">    <a class="code" href="group__group__syspm__data__enumerates.html#ga601b1cb722cb091133caf33d8ab235ca">cy_en_syspm_status_t</a> retVal = <a class="code" href="group__group__syspm__data__enumerates.html#gga601b1cb722cb091133caf33d8ab235caa5e406c6cb40fdf6663df0208737d4f11">CY_SYSPM_FAIL</a>;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span>(callbackParams-&gt;<a class="code" href="structcy__stc__syspm__callback__params__t.html#a2737abe860f048be7574b0f95f22e18c">mode</a>)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Check is the HW2 ready to enter into the deep sleep */</span></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__group__syspm__data__enumerates.html#ggae06cd8869fe61d709ad6145ca9f3cd63ab7ec706d80b347433d0063f2a8115784">CY_SYSPM_CHECK_READY</a>:</div><div class="line">        </div><div class="line">            <span class="keywordflow">if</span>(<span class="keyword">true</span><span class="comment">/* HW2 is ready */</span>)</div><div class="line">            {</div><div class="line">                <span class="comment">/* Process the &quot;check ready&quot; condition */</span></div><div class="line">                retVal = <a class="code" href="group__group__syspm__data__enumerates.html#gga601b1cb722cb091133caf33d8ab235caaf00d22f1ee891a8a56f8bbf58132e775">CY_SYSPM_SUCCESS</a>;</div><div class="line">            }</div><div class="line">        </div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">    </div><div class="line">    <span class="keywordflow">return</span> (retVal);</div><div class="line">}</div></div><!-- fragment --><p> Finally, we register the callbacks so that the SysPm driver knows about them. The order in which the callbacks will be called depends upon the order in which the callbacks are registered. If there are no callbacks registered, the device just executes the power mode transition.</p>
<p>Callbacks that reconfigure global resources, such as clock frequencies, should be registered last. They then modify global resources as the final step before entering the low power mode, and restore those resources first, as the system returns from low-power mode.</p>
<div class="fragment"><div class="line">    <span class="comment">/* Register the myDeepSleep1 */</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group__group__syspm__data__enumerates.html#gga601b1cb722cb091133caf33d8ab235caaf00d22f1ee891a8a56f8bbf58132e775">CY_SYSPM_SUCCESS</a> != <a class="code" href="group__group__syspm__functions__callback.html#ga0d58b00c8dc764a6371590f70e2f73c7">Cy_SysPm_RegisterCallback</a>(&amp;myDeepSleep1))</div><div class="line">    {</div><div class="line">        <span class="comment">/* Insert error handling */</span></div><div class="line">    }</div><div class="line">    </div><div class="line">    <span class="comment">/* Register the mySleep1 */</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group__group__syspm__data__enumerates.html#gga601b1cb722cb091133caf33d8ab235caaf00d22f1ee891a8a56f8bbf58132e775">CY_SYSPM_SUCCESS</a> != <a class="code" href="group__group__syspm__functions__callback.html#ga0d58b00c8dc764a6371590f70e2f73c7">Cy_SysPm_RegisterCallback</a>(&amp;mySleep1))</div><div class="line">    {</div><div class="line">        <span class="comment">/* Insert error handling */</span></div><div class="line">    }</div><div class="line">    </div><div class="line">    <span class="comment">/* Register the myDeepSleep2 */</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group__group__syspm__data__enumerates.html#gga601b1cb722cb091133caf33d8ab235caaf00d22f1ee891a8a56f8bbf58132e775">CY_SYSPM_SUCCESS</a> != <a class="code" href="group__group__syspm__functions__callback.html#ga0d58b00c8dc764a6371590f70e2f73c7">Cy_SysPm_RegisterCallback</a>(&amp;myDeepSleep2))</div><div class="line">    {</div><div class="line">        <span class="comment">/* Insert error handling */</span></div><div class="line">    }</div></div><!-- fragment --><p> We are done configuring three callbacks. Now the SysPm driver will execute the callbacks appropriately whenever there is a call to a power mode transition function: <a class="el" href="group__group__syspm__functions__power.html#ga4f9e1d22b5e0222f052c017cbe8a10d3">Cy_SysPm_Sleep()</a>, <a class="el" href="group__group__syspm__functions__power.html#ga1211c6447be4863cb7ca807e2c9f98ee">Cy_SysPm_DeepSleep()</a>, <a class="el" href="group__group__syspm__functions__power.html#ga8ff9480e354c01a80b2597b1c16d8126">Cy_SysPm_EnterLowPowerMode()</a>, <a class="el" href="group__group__syspm__functions__power.html#gae2d2dd20ca4ec0e37915c5883fe9db1d">Cy_SysPm_ExitLowPowerMode()</a>, and <a class="el" href="group__group__syspm__functions__power.html#ga2929e98b966d58c9246108a767ed7f53">Cy_SysPm_Hibernate()</a>. </p><dl class="section note"><dt>Note</dt><dd>On a wakeup from hibernate the device goes through a reset, so the callbacks with CY_SYSPM_AFTER_TRANSITION are not executed. Refer to <a class="el" href="group__group__syspm__functions__power.html#ga2929e98b966d58c9246108a767ed7f53">Cy_SysPm_Hibernate()</a> for more details.</dd></dl>
<p>Refer to <a class="el" href="group__group__syspm.html#group_syspm_cb_uregistering">Callback Unregistering</a> in <a class="el" href="group__group__syspm.html#group_syspm_cb_config_consideration">Callback Configuration Considerations</a> to learn what to do if you need to remove the callback from the linked list. You might want to unregister the callback for debug purposes.</p>
<p>Refer to <a class="el" href="group__group__syspm.html#group_syspm_cb_flow">Callbacks Execution Flow</a> in <a class="el" href="group__group__syspm.html#group_syspm_cb_config_consideration">Callback Configuration Considerations</a> to learn about how the SysPm is processing the callbacks.</p>
<h2><a class="anchor" id="group_syspm_cb_config_consideration"></a>
Callback Configuration Considerations</h2>
<h3><a class="anchor" id="group_syspm_cb_parameters"></a>
Callback Function Parameters</h3>
<p>The <b>callbackParams</b> parameter of the callback function is a <a class="el" href="structcy__stc__syspm__callback__params__t.html">cy_stc_syspm_callback_params_t</a> structure. The first field in this structure (<b>mode</b>) is for internal use. In the example code we used a dummy value CY_SYSPM_CHECK_READY to eliminate compilation errors associated with the enumeration. The driver sets the <b>mode</b> field to the correct value when calling the callback functions (the mode is referred to as step in the <a class="el" href="group__group__syspm.html#group_syspm_cb_function_implementation">Callback Function Implementation</a>). The callback function reads the value and acts based on the mode set by the SysPm driver. The <b>base</b> and <b>context</b> fields are optional and can be NULL. Some drivers require a base hardware address and a context. If your callback routine needs access to the driver registers or context, provide those values (see <a href="..\..\pdl_user_guide.pdf">PDL Design</a> section to learn about Base Hardware Address). Be aware of MISRA warnings if these parameters are NULL.</p>
<h3><a class="anchor" id="group_syspm_cb_structures"></a>
Callback Function Structure</h3>
<p>For each callback, provide a <a class="el" href="structcy__stc__syspm__callback__t.html">cy_stc_syspm_callback_t</a> structure. Some fields in this structure are maintained by the driver. Use NULL for <b>prevItm</b> and <b>nextItm</b>. The driver uses these fields to build a linked list of callback functions.</p>
<dl class="section warning"><dt>Warning</dt><dd>The <a class="el" href="group__group__syspm__functions__callback.html#ga0d58b00c8dc764a6371590f70e2f73c7" title="Registers a new syspm callback. ">Cy_SysPm_RegisterCallback()</a> function stores a pointer to the <a class="el" href="structcy__stc__syspm__callback__t.html" title="The structure with the syspm callback configuration elements. ">cy_stc_syspm_callback_t</a> variable. Do not modify elements of the <a class="el" href="structcy__stc__syspm__callback__t.html" title="The structure with the syspm callback configuration elements. ">cy_stc_syspm_callback_t</a> structure after the callback is registered. You are responsible for ensuring that the variable remains in scope. Typically the structure is declared as a global or static variable, or as a local variable in the main() function.</dd></dl>
<h3><a class="anchor" id="group_syspm_cb_function_implementation"></a>
Callback Function Implementation</h3>
<p>Every callback function should handle four possible steps (referred to as "mode") defined in <a class="el" href="group__group__syspm__data__enumerates.html#gae06cd8869fe61d709ad6145ca9f3cd63">cy_en_syspm_callback_mode_t</a> : <br />
</p><ul>
<li>CY_SYSPM_CHECK_READY - prepare for entering a low power mode<br />
</li>
<li>CY_SYSPM_BEFORE_TRANSITION - The actions to be done before entering the low-power mode <br />
</li>
<li>CY_SYSPM_AFTER_TRANSITION - The actions to be done after exiting the low-power mode <br />
</li>
<li>CY_SYSPM_CHECK_FAIL - roll back the actions done in the callbacks executed previously with CY_SYSPM_CHECK_READY <br />
</li>
</ul>
<p>A callback function can skip steps (see <a class="el" href="group__group__syspm__skip__callback__modes.html">The Defines to skip the callbacks modes</a>). In our example mySleep1 and myDeepSleep1 callbacks do nothing while entering the low power mode (skip on CY_SYSPM_BEFORE_TRANSITION). If there is anything preventing low power mode entry - return CY_SYSPM_FAIL in response to CY_SYSPM_CHECK_READY in your callback implementation. Note that the callback should return CY_SYSPM_FAIL only in response to CY_SYSPM_CHECK_READY. The callback function should always return CY_SYSPM_PASS for other modes: CY_SYSPM_CHECK_FAIL, CY_SYSPM_BEFORE_TRANSITION, and CY_SYSPM_AFTER_TRANSITION (see <a class="el" href="group__group__syspm.html#group_syspm_cb_flow">Callbacks Execution Flow</a>).</p>
<h3><a class="anchor" id="group_syspm_cb_flow"></a>
Callbacks Execution Flow</h3>
<p>This section explains what happens during a power transition, when callbacks are implemented and set up correctly. The following discussion assumes: <br />
</p><ul>
<li>All required callback functions are defined and implemented <br />
</li>
<li>All <a class="el" href="structcy__stc__syspm__callback__t.html" title="The structure with the syspm callback configuration elements. ">cy_stc_syspm_callback_t</a> structures are filled with required values <br />
</li>
<li>All callbacks are successfully registered</li>
</ul>
<p>User calls one of the power mode transition functions: <a class="el" href="group__group__syspm__functions__power.html#ga4f9e1d22b5e0222f052c017cbe8a10d3">Cy_SysPm_Sleep()</a>, <a class="el" href="group__group__syspm__functions__power.html#ga1211c6447be4863cb7ca807e2c9f98ee">Cy_SysPm_DeepSleep()</a>, <a class="el" href="group__group__syspm__functions__power.html#ga8ff9480e354c01a80b2597b1c16d8126">Cy_SysPm_EnterLowPowerMode()</a>, <a class="el" href="group__group__syspm__functions__power.html#gae2d2dd20ca4ec0e37915c5883fe9db1d">Cy_SysPm_ExitLowPowerMode()</a>, and <a class="el" href="group__group__syspm__functions__power.html#ga2929e98b966d58c9246108a767ed7f53">Cy_SysPm_Hibernate()</a>. It calls each callback with the mode set to CY_SYSPM_CHECK_READY. This triggers execution of the code for that step inside of each user callback.</p>
<p>If that process is successful for all callbacks, then <a class="el" href="group__group__syspm__functions__callback.html#ga95462119281ba8dec6b313f85dd752b0">Cy_SysPm_ExecuteCallback()</a> calls each callback with the mode set to CY_SYSPM_BEFORE_TRANSITION. This triggers execution of the code for that step inside each user callback. We then enter the low power mode.</p>
<p>When exiting the low power mode, the SysPm driver executes <a class="el" href="group__group__syspm__functions__callback.html#ga95462119281ba8dec6b313f85dd752b0">Cy_SysPm_ExecuteCallback()</a> again. This time it calls each callback in reverse order, with the mode set to CY_SYSPM_AFTER_TRANSITION. This triggers execution of the code for that step inside each user callback. When complete, we are back to Active state.</p>
<p>A callback can return CY_SYSPM_FAIL only while executing the CY_SYSPM_CHECK_READY step. If that happens, then the remaining callbacks are not executed. Any callbacks that have already executed are called again, in reverse order, with CY_SYSPM_CHECK_FAIL. This allows the system to return to the previous state. Then any of the functions (<a class="el" href="group__group__syspm__functions__power.html#ga4f9e1d22b5e0222f052c017cbe8a10d3">Cy_SysPm_Sleep()</a>, <a class="el" href="group__group__syspm__functions__power.html#ga1211c6447be4863cb7ca807e2c9f98ee">Cy_SysPm_DeepSleep()</a>, <a class="el" href="group__group__syspm__functions__power.html#ga8ff9480e354c01a80b2597b1c16d8126">Cy_SysPm_EnterLowPowerMode()</a>, <a class="el" href="group__group__syspm__functions__power.html#gae2d2dd20ca4ec0e37915c5883fe9db1d">Cy_SysPm_ExitLowPowerMode()</a>, and <a class="el" href="group__group__syspm__functions__power.html#ga2929e98b966d58c9246108a767ed7f53">Cy_SysPm_Hibernate()</a>) that attempted to switch the device into a low power mode will return CY_SYSPM_FAIL.</p>
<p>Callbacks that reconfigure global resources, such as clock frequencies, should be registered last. They then modify global resources as the final step before entering the low power mode, and restore those resources first, as the system returns from Low-power mode.</p>
<h3><a class="anchor" id="group_syspm_cb_uregistering"></a>
Callback Unregistering</h3>
<p>Unregistering the callback might be useful when you need dynamically manage the callbacks.</p>
<div class="fragment"><div class="line">    <span class="comment">/* Scenario: there is a need to unregister previously registered callback */</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group__group__syspm__data__enumerates.html#gga601b1cb722cb091133caf33d8ab235caaf00d22f1ee891a8a56f8bbf58132e775">CY_SYSPM_SUCCESS</a> != <a class="code" href="group__group__syspm__functions__callback.html#gab7b9b923fceff2f37a6b8288253b0e82">Cy_SysPm_UnregisterCallback</a>(&amp;mySleep1))</div><div class="line">    {</div><div class="line">        <span class="comment">/* Insert error handling */</span></div><div class="line">    }</div></div><!-- fragment --><p>The callback structures after mySleep1 callback is unregistered: </p><div class="image">
<img src="syspm_2_10_unregistration.png" alt="syspm_2_10_unregistration.png"/>
</div>
<h1><a class="anchor" id="group_syspm_definitions"></a>
Definitions</h1>
<table class="doxtable">
<tr>
<th>Term </th><th><p class="starttd">Definition </p>
<p class="endtd"></p>
</th></tr>
<tr>
<td>LDO </td><td><p class="starttd">Low Dropout Linear Regulator (LDO). The functions that manage this block are grouped as <a class="el" href="group__group__syspm__functions__ldo.html">LDO</a> under <a class="el" href="group__group__syspm__functions__core__regulators.html">Core Voltage Regulation</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>SIMO Buck </td><td><p class="starttd">Single Inductor Multiple Output Buck Regulator, referred as "Buck regulator" throughout the documentation. The functions that manage this block are grouped as <a class="el" href="group__group__syspm__functions__buck.html">Buck</a> under <a class="el" href="group__group__syspm__functions__core__regulators.html">Core Voltage Regulation</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>PMIC </td><td><p class="starttd">Power Management Integrated Circuit. The functions that manage this block are grouped as <a class="el" href="group__group__syspm__functions__pmic.html">PMIC</a> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>LPActive </td><td>Low-Power Active mode. The MCU power mode. See the <a class="el" href="group__group__syspm.html#group_syspm_switching_into_lpactive">Switching Device into LPActive</a> section for details  </td></tr>
</table>
<h1><a class="anchor" id="group_syspm_section_more_information"></a>
More Information</h1>
<p>For more information on the Power Management (SysPm) driver, refer to the technical reference manual (TRM).</p>
<h1><a class="anchor" id="group_syspm_MISRA"></a>
MISRA-C Compliance</h1>
<p>The SysPm driver does not have any specific deviations.</p>
<h1><a class="anchor" id="group_syspm_changelog"></a>
Changelog</h1>
<table class="doxtable">
<tr>
<th>Version</th><th>Changes</th><th>Reason for Change </th></tr>
<tr>
<td>2.21 </td><td>Removed saving/restoring the SysClk measurement counters while in Deep Sleep routine  </td><td>Removed possible corruption of SysClk measurement counters if the core wakes up from the Deep Sleep   </td></tr>
<tr>
<td>2.20 </td><td><br />
<ul>
<li>Added support for changing core voltage when the protection context is other that zero. Such support is available only for devices that support modifying registers via syscall</li>
<li>For preproduction PSoC 6 devices the changing core voltage is prohibited when the protection context is other than zero.</li>
<li>Updated the following functions. They now have a <a class="el" href="group__group__syspm__data__enumerates.html#ga601b1cb722cb091133caf33d8ab235ca">cy_en_syspm_status_t</a> return value and use a syscall: <br />
 Cy_SysPm_LdoSetVoltage <br />
 Cy_SysPm_BuckSetVoltage1 <br />
 Cy_SysPm_BuckEnable <br />
 No backward compatibility issues</li>
<li>Added new CY_SYSPM_CANCELED element in the <a class="el" href="group__group__syspm__data__enumerates.html#ga601b1cb722cb091133caf33d8ab235ca">cy_en_syspm_status_t</a></li>
<li>Documentation updates</li>
<li>Added warning that Cy_SysPm_PmicDisable(CY_SYSPM_PMIC_POLARITY_LOW) is not supported by hardware  </li>
</ul>
</td><td>Added support for changing the core voltage in protection context higher that zero (PC &gt; 0) <br />
 Documentation update and clarification   </td></tr>
<tr>
<td>2.10 </td><td><br />
<ul>
<li>Changed names for all Backup, Buck-related functions, defines, and enums <br />
</li>
<li>Changed next power mode function names: <br />
 Cy_SysPm_EnterLpMode <br />
 Cy_SysPm_ExitLpMode <br />
 Cy_SysPm_SetHibWakeupSource <br />
 Cy_SysPm_ClearHibWakeupSource <br />
 Cy_SysPm_GetIoFreezeStatus <br />
</li>
<li>Changed following enumeration names: <br />
 cy_en_syspm_hib_wakeup_source_t <br />
 cy_en_syspm_simo_buck_voltage1_t <br />
 cy_en_syspm_simo_buck_voltage2_t <br />
</li>
<li>Updated Power Modes documentation section <br />
</li>
<li>Added Low Power Callback Managements section <br />
</li>
<li>Documentation edits  </li>
</ul>
</td><td>Improvements made based on usability feedback <br />
 Documentation update and clarification   </td></tr>
<tr>
<td>2.0 </td><td>Enhancement and defect fixes: <br />
<ul>
<li>Added input parameter(s) validation to all public functions <br />
</li>
<li>Removed "_SysPm_" prefixes from the internal functions names <br />
</li>
<li>Changed the type of elements with limited set of values, from uint32_t to enumeration</li>
<li>Enhanced syspm callback mechanism</li>
<li>Added functions to control: <br />
<ul>
<li>Power supply for the Vddbackup <br />
</li>
<li>Supercapacitor charge <br />
</li>
<li>Vddbackup measurement by ADC <br />
  </li>
</ul>
</li>
</ul>
</td><td></td></tr>
<tr>
<td>1.0 </td><td>Initial version </td><td></td></tr>
</table>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="groups"></a>
API Reference</h2></td></tr>
<tr class="memitem:group__group__syspm__macros"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__group__syspm__macros.html">Macros</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:group__group__syspm__functions"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__group__syspm__functions.html">Functions</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:group__group__syspm__data__structures"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__group__syspm__data__structures.html">Data Structures</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:group__group__syspm__data__enumerates"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__group__syspm__data__enumerates.html">Enumerated Types</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part
<div id="nav-path" class="navpath">
    <ul>
        <li class="footer">
            Generated for <b>Cypress Peripheral Driver Library (PDL)</b> by <b>Cypress Semiconductor Corporation</b>.
            All rights reserved.
        </li>
    </ul>
</div>
-->
</body>
</html>
