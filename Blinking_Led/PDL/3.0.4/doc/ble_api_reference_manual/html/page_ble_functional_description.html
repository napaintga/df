<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cypress BLE Middleware Library: Functional Description</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen_style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://www.cypress.com/"><img alt="Logo" src="cypress_logo.png"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Cypress BLE Middleware Library
   &#160;<span id="projectnumber">2.20</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('page_ble_functional_description.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Functional Description </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="group_ble_operation_flow"></a>
Operation Flow</h1>
<p>A typical application code consists of three separate stages: Initialization, Normal operation, and Low-power operation.</p>
<div class="image">
<img src="ble_operation_flow.png" alt="ble_operation_flow.png"/>
</div>
<p>After initialization, the BLE Middleware enters normal operation and periodically enters various degrees of low-power operation to conserve power. Therefore, initialization should only happen at system power-up, and the BLE Middleware should operate between normal mode and low-power mode afterwards. </p>
<h2><a class="anchor" id="group_ble_system_init"></a>
System Initialization</h2>
<p>The initialization stage happens at system power-up or when waking from system hibernation. This stage sets up the platform and the BLE Middleware parameters. The application code should also start the Component and set up the callback functions for the event callbacks that will happen in the other modes of operation.</p>
<h2><a class="anchor" id="group_ble_system_normal_operation"></a>
System Normal Operation</h2>
<p>Upon successful initialization of the BLE Middleware or hibernate wakeup sequence, the Component enters normal mode. Normal operation first establishes a BLE connection if it is not already connected. It should then process all pending BLE events by checking the stack status. This is accomplished by calling <a class="el" href="group__group__ble__common__api__functions.html#ga0f1982f915c28b0d5a317442bec9eafc" title="This function checks the internal task queue in the BLE Stack, and pending operation of the BLE Stack...">Cy_BLE_ProcessEvents()</a>. When all events have been processed, it can transmit any data that need to be communicated and enters low-power operation unless there is another pending event. In such a case, it should execute the normal operation flow again. Processing of BLE events should be performed at least once in a BLE connection event period. The BLE connection event is configured by the Central device while establishing a connection.</p>
<h2><a class="anchor" id="group_ble_system_lpm"></a>
System Low-power Operation</h2>
<p>When there are no pending interrupts in normal operation, the BLE Middleware should be placed in low-power mode. It should first enter Sleep mode. The BLE Middleware can enter either CPU sleep or deep sleep mode depending on the state of the BLE interface hardware. If an event happens at any time in low-power mode, it should re-enter normal operation. </p><dl class="section note"><dt>Note</dt><dd>The MCU and BLE Sub-System (BLESS) have separate power modes and are able to go to different power modes independent of each other. The check marks in the following table show the possible combination of power modes of MCU and BLESS. </dd></dl>
<dl class="section user"><dt></dt><dd><table class="doxtable">
<tr>
<th rowspan="2">BLESS<br />
Power Modes </th><th colspan="5">MCU Power Modes  </th></tr>
<tr>
<td>Active </td><td>Sleep </td><td>Deep sleep </td><td>Hibernate </td><td>Stop  </td></tr>
<tr>
<td>Active (idle/Tx/Rx) </td><td align="center">Y </td><td align="center">Y </td><td></td><td></td><td></td></tr>
<tr>
<td>Sleep </td><td align="center">Y </td><td align="center">Y </td><td></td><td></td><td></td></tr>
<tr>
<td>Deep sleep (ECO off) </td><td align="center">Y </td><td align="center">Y </td><td align="center">Y </td><td></td><td></td></tr>
<tr>
<td>Off </td><td></td><td></td><td></td><td align="center">Y </td><td align="center">Y  </td></tr>
</table>
</dd></dl>
<h1><a class="anchor" id="group_ble_device_bonding"></a>
Device Bonding</h1>
<p>The BLE Middleware will store the link key of a connection after pairing with the remote device. If a connection is lost and re-established, the devices will use the previously stored key for the connection. The BLE stack will update the bonding data in RAM while the devices are connected. If the bonding data is to be retained during shutdown, the application can use <a class="el" href="group__group__ble__common__api__functions.html#ga778852ddcd6a37606668984aca7c3754" title="This function writes the new bonding data from RAM to the dedicated Flash location as defined by the ...">Cy_BLE_StoreBondingData()</a> API to write the bonding data from RAM to the dedicated Flash location, as defined by the BLE Middleware. Refer to the CE215121_BLE_HID_Keyboard code example for usage details.</p>
<h1><a class="anchor" id="group_ble_lfclk_conf"></a>
LFCLK Configuration for Deep Sleep Mode</h1>
<p>The LFCLK configuration affects the BLE Middleware's ability to operate in deep sleep mode. If the WCO or PILO are chosen as source clock, then the BLE Middleware CPU deep sleep mode is available for use. However, if the ILO is chosen, then the BLE Middleware cannot enter CPU deep sleep.</p>
<p>Refer to the <b>Advanced Tab</b> section of <a href="http://www.cypress.com/documentation/component-datasheets/bluetooth-low-energy-blepdl">Bluetooth Low Energy (BLE_PDL) Datasheet </a> for information on how to enable low-power mode in the BLE Middleware.</p>
<dl class="section note"><dt>Note</dt><dd>The BLE middleware uses the LFCLK only during CPU deep sleep mode, so ILO inaccuracy does not affect BLE communication.</dd></dl>
<h2><a class="anchor" id="group_ble_lfclk_Pilo_conf"></a>
Configuring PILO for Deep Sleep Mode</h2>
<p>The BLE Middleware supports using the Precision ILO (PILO) (instead of the WCO) as the LF clock source.</p>
<p>Using the PILO has limitations:</p><ul>
<li>supports only a single connection</li>
<li>supports only the Peripheral/Slave role</li>
<li>not supported for preproduction hardware.</li>
</ul>
<p>Using the PILO as the LF clock source requires:</p><ul>
<li>initial trimming and measuring the step size of the PILO trimming before BLE start</li>
<li>setting the clock configuration of the BLE sub-system after BLE start Both actions must happen during every power-up to get closest to the target frequency.</li>
</ul>
<p>The following code snippet shows the implementation: </p><div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#define LF_COUNT          (64u)</span></div><div class="line"><span class="preprocessor">#define FREQ_REF          (31250u)</span></div><div class="line"><span class="preprocessor">#define TRIM_DELAY        (2000u)</span></div><div class="line"><span class="preprocessor">#define STEP_SIZE_ITER    (8u)</span></div><div class="line"></div><div class="line">uint16_t initialFtrim = 0u;</div><div class="line">    </div><div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> Cy_BLE_HAL_SetPiloTrimStep(uint32_t stepSize);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/*******************************************************************************</span></div><div class="line"><span class="comment">* Function Name: PILO_InitialTrim</span></div><div class="line"><span class="comment">****************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> PILO_InitialTrim(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint64_t measuredCnt = 0xFFFFFFFF;</div><div class="line">    uint16_t trimVal = 0u;</div><div class="line">    int8_t bitPos = 9;</div><div class="line">    </div><div class="line">    <span class="keywordflow">do</span></div><div class="line">    {</div><div class="line">        SRSS-&gt;CLK_PILO_CONFIG &amp;= ~(SRSS_CLK_PILO_CONFIG_PILO_FFREQ_Msk);</div><div class="line">        </div><div class="line">        <span class="comment">/* Set 1 at BitPos in FTRIM*/</span></div><div class="line">        SRSS-&gt;CLK_PILO_CONFIG |= (trimVal | (1 &lt;&lt; bitPos));</div><div class="line">        </div><div class="line">        <span class="comment">/* Wait for 2 ms after setting FTRIM */</span></div><div class="line">        Cy_SysLib_DelayUs(TRIM_DELAY);</div><div class="line"></div><div class="line">        <span class="comment">/* Start frequency measurement of PILO for </span></div><div class="line"><span class="comment">         * 64 PILO clock counts with BLE ECO ALTHF(configured to 16MHz) as reference clock */</span> </div><div class="line">        Cy_SysClk_StartClkMeasurementCounters(CY_SYSCLK_MEAS_CLK_PILO, LF_COUNT, CY_SYSCLK_MEAS_CLK_ALTHF);</div><div class="line">        <span class="keywordflow">while</span> ( <span class="keyword">true</span> != Cy_SysClk_ClkMeasurementCountersDone() )</div><div class="line">        {</div><div class="line">            <span class="comment">/* Wait for the measurement to complete */</span></div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Read the number of reference clock cycles for 64 PILO clock cycles */</span></div><div class="line">        measuredCnt = (uint64_t)_FLD2VAL(SRSS_CLK_CAL_CNT2_CAL_COUNTER2, SRSS-&gt;CLK_CAL_CNT2);</div><div class="line"></div><div class="line">        <span class="comment">/* If the measured clock cycles are greater than expected 31250 cycles, retain the bitPos as 1 in FTRIM */</span></div><div class="line">        <span class="keywordflow">if</span> (measuredCnt &gt; FREQ_REF)</div><div class="line">        {</div><div class="line">            trimVal |= (1 &lt;&lt; bitPos);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Repeat until this is done for all 10 bits of FTRIM */</span></div><div class="line">        bitPos--;</div><div class="line">        </div><div class="line">    } <span class="keywordflow">while</span> (bitPos &gt;= 0);</div><div class="line"></div><div class="line">    SRSS-&gt;CLK_PILO_CONFIG &amp;= ~(SRSS_CLK_PILO_CONFIG_PILO_FFREQ_Msk);</div><div class="line">    SRSS-&gt;CLK_PILO_CONFIG |= (trimVal);</div><div class="line">    initialFtrim = _FLD2VAL(SRSS_CLK_PILO_CONFIG_PILO_FFREQ, SRSS-&gt;CLK_PILO_CONFIG);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/*******************************************************************************</span></div><div class="line"><span class="comment">* Function Name: PILO_MeasureStepSize</span></div><div class="line"><span class="comment">****************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> PILO_MeasureStepSize(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint16_t iteration = 0u;</div><div class="line">    uint32_t fTrim     = 0u;</div><div class="line">    uint32_t newFreq   = 0u;</div><div class="line">    uint32_t oldFreq   = 0u;</div><div class="line">    uint8_t  stepSize  = 8;</div><div class="line">    </div><div class="line">    Cy_SysClk_StartClkMeasurementCounters(CY_SYSCLK_MEAS_CLK_PILO, 212u, CY_SYSCLK_MEAS_CLK_ALTHF);</div><div class="line">    <span class="keywordflow">while</span> ( <span class="keyword">true</span> != Cy_SysClk_ClkMeasurementCountersDone() )</div><div class="line">    {</div><div class="line">        <span class="comment">/* Wait for the measurement to complete */</span></div><div class="line">    }</div><div class="line">    </div><div class="line">    oldFreq = Cy_SysClk_ClkMeasurementCountersGetFreq(<span class="keyword">false</span>, 16000000u);</div><div class="line">    <span class="keywordflow">do</span></div><div class="line">    {</div><div class="line">        fTrim = _FLD2VAL(SRSS_CLK_PILO_CONFIG_PILO_FFREQ, SRSS-&gt;CLK_PILO_CONFIG);</div><div class="line"></div><div class="line">        <span class="comment">/* Update the fine trim value */</span></div><div class="line">        CY_SYSCLK_CLR_SET(SRSS-&gt;CLK_PILO_CONFIG, SRSS_CLK_PILO_CONFIG_PILO_FFREQ, fTrim + 1u);</div><div class="line"></div><div class="line">        <span class="comment">/* Wait for 2 ms after setting FTRIM */</span></div><div class="line">        Cy_SysLib_DelayUs(TRIM_DELAY);</div><div class="line"></div><div class="line">        Cy_SysClk_StartClkMeasurementCounters(CY_SYSCLK_MEAS_CLK_PILO, 212u, CY_SYSCLK_MEAS_CLK_ALTHF);</div><div class="line">        <span class="keywordflow">while</span> ( <span class="keyword">true</span> != Cy_SysClk_ClkMeasurementCountersDone() )</div><div class="line">        {</div><div class="line">            <span class="comment">/* Wait for the measurement to complete */</span></div><div class="line">        }</div><div class="line">        newFreq = Cy_SysClk_ClkMeasurementCountersGetFreq(<span class="keyword">false</span>, 16000000u);</div><div class="line"></div><div class="line">        stepSize += (newFreq - oldFreq);</div><div class="line">        oldFreq = newFreq;</div><div class="line">        iteration++;</div><div class="line">        </div><div class="line">    } <span class="keywordflow">while</span> (iteration &lt; STEP_SIZE_ITER);</div><div class="line"></div><div class="line">    stepSize = (stepSize/STEP_SIZE_ITER);</div><div class="line"></div><div class="line">    <span class="comment">/* Restore the fine trim value */</span></div><div class="line">    CY_SYSCLK_CLR_SET(SRSS-&gt;CLK_PILO_CONFIG, SRSS_CLK_PILO_CONFIG_PILO_FFREQ, initialFtrim);</div><div class="line"></div><div class="line">    <span class="comment">/* Wait for 2 ms after setting FTRIM */</span></div><div class="line">    Cy_SysLib_DelayUs(TRIM_DELAY);</div><div class="line">    </div><div class="line">    <span class="comment">/* Store measured step size */</span></div><div class="line">    Cy_BLE_HAL_SetPiloTrimStep(stepSize);</div><div class="line">}</div><div class="line"></div></div><!-- fragment --><p> To set the clock configuration of the BLE sub-system use function Cy_BLE_SetBleClockCfgParam(&amp;param) after CY_BLE_EVT_STACK_ON event. The param structure must have the following field values for the sleep clock accuracy and Link Layer clock divider:</p><ul>
<li>param-&gt;bleLlSca = CY_BLE_LL_SCA_251_TO_500_PPM,</li>
<li>param-&gt;bleLlClockDiv = CY_BLE_LL_ECO_CLK_DIV_2.</li>
</ul>
<p>Note: Trimming functions PILO_InitialTrim and PILO_MeasureStepSize must be called before <a class="el" href="group__group__ble__common__api__creator__functions.html#gaf0d1f25c45f71b5a2a7c28ce23057c06" title="This function initializes the BLE Stack which consists of the BLE Stack Manager, BLE Controller...">Cy_BLE_Start()</a>, and must be called on the CPU core running the BLE controller.</p>
<h1><a class="anchor" id="group_ble_multiconnection_support"></a>
Multi-Connection Support</h1>
<p>The BLE Middleware supports up to four simultaneous Multi-Master Multi-Slave (MMMS) BLE connections in any combination of roles. For example, it can be a master of four slave devices (4M), a master of three slave devices and a slave of another device (3M1S), or a slave of four devices (4S), or any other combination. To configure the maximum number of BLE connections, refer to the <b>General Tab</b> section of <a href="http://www.cypress.com/documentation/component-datasheets/bluetooth-low-energy-blepdl">Bluetooth Low Energy (BLE_PDL) Datasheet</a>(Maximum number of BLE connections). The BLE Middleware supports a single instance of a GATT Server (single GATT database). The number of the Server instance field is always fixed to 1 in the BLE_PDL Configure dialog. You can add additional Services or a complete Server Profile to the existing Server tree and build a GATT database. This single GATT database is reused across all BLE connections. The BLE Middleware manages multiple CCCD values. The CCCD value for each active connection is unique.</p>
<p>The maximum number of CCCD storage SRAM data structures supported by the BLE Middleware is determined by the number of active BLE connections/links that you select. The BLE Middleware restores CCCD values in flash for each of the bonded devices while establishing a connection with a peer device.</p>
<p>Use the connection handle at the application level to manage the multi-connection. The connection handle (<a class="el" href="structcy__stc__ble__conn__handle__t.html">cy_stc_ble_conn_handle_t</a>) appears when the connection is established (as the event parameter of the <a class="el" href="group__group__ble__common__api__events.html#gga7c1ef7e6d246e0f3eb6c883e23d82b86aff4f3e61e6d3125ac81bf0c92be85ab5">CY_BLE_EVT_GATT_CONNECT_IND</a> event).</p>
<p>To work with a particular connection, BLE APIs (BLE Stack APIs, BLE Profile APIs) provide the parameter connHandle (e.g., Cy_BLE_BASS_SendNotification(<a class="el" href="structcy__stc__ble__conn__handle__t.html" title="Connection Handle. ">cy_stc_ble_conn_handle_t</a> connHandle,... ).) BLE events from the AppCallback function include a connHandle in eventParam structures to distinguish to which connection this event relates. The following code shows how an application can manage connection handles:</p>
<div class="fragment"><div class="line"><span class="comment">/* Allocate the connection handle array. Macro CY_BLE_CONN_COUNT indicates the MAX number of supported connection. */</span></div><div class="line"><a class="code" href="structcy__stc__ble__conn__handle__t.html">cy_stc_ble_conn_handle_t</a> appConnHandle[CY_BLE_CONN_COUNT] = {<a class="code" href="group__group__ble__common__api__macros.html#ga4f351ae5e87a246f8bfe7ab72f19299f">CY_BLE_INVALID_CONN_HANDLE_VALUE</a>};</div><div class="line"></div><div class="line"><span class="comment">/*  The callback event function to handle various events from the BLE stack */</span></div><div class="line"><span class="keywordtype">void</span> AppCallback (uint32 event, <span class="keywordtype">void</span>* eventParam)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (event)</div><div class="line">    {</div><div class="line">        ...</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__group__ble__common__api__events.html#gga7c1ef7e6d246e0f3eb6c883e23d82b86aff4f3e61e6d3125ac81bf0c92be85ab5">CY_BLE_EVT_GATT_CONNECT_IND</a>:</div><div class="line">        <span class="comment">/* Add the connected device to the connection handle array */</span> </div><div class="line">        appConnHandle[ (*(<a class="code" href="structcy__stc__ble__conn__handle__t.html">cy_stc_ble_conn_handle_t</a> *)eventParam).attId ] = </div><div class="line">                        *(<a class="code" href="structcy__stc__ble__conn__handle__t.html">cy_stc_ble_conn_handle_t</a> *) eventParam; </div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__group__ble__common__api__events.html#gga7c1ef7e6d246e0f3eb6c883e23d82b86af587c72e44312a1c627bc7c2694b804c">CY_BLE_EVT_GATT_DISCONNECT_IND</a>:</div><div class="line">        <span class="comment">/* Remove the connected device from the connection handle array */</span> </div><div class="line">        memset(&amp;appConnHandle[(*(<a class="code" href="structcy__stc__ble__conn__handle__t.html">cy_stc_ble_conn_handle_t</a>*)eventParam).attId], </div><div class="line">               <a class="code" href="group__group__ble__common__api__macros.html#ga4f351ae5e87a246f8bfe7ab72f19299f">CY_BLE_INVALID_CONN_HANDLE_VALUE</a>, </div><div class="line">               <span class="keyword">sizeof</span>(<a class="code" href="structcy__stc__ble__conn__handle__t.html">cy_stc_ble_conn_handle_t</a>));</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>Loop through all connected devices: </p><div class="fragment"><div class="line"><span class="keywordflow">for</span> (i = 0; i &lt; CY_BLE_CONN_COUNT; i++)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span>(<a class="code" href="group__group__ble__common__api__functions.html#gaa8b78b1e8bba23c0916c7d889096fbbd">Cy_BLE_GetConnectionState</a>(appConnHandle[i]) == <a class="code" href="group__group__ble__common__api__gap__definitions.html#ggad0312d72df4feae7292ab7a18944d4b5aa06bd189c8ddb0370e563b2f8e488f10">CY_BLE_CONN_STATE_CONNECTED</a>)</div><div class="line">    {</div><div class="line">     <span class="comment">/* Do some action */</span></div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>Use the <a class="el" href="group__group__ble__common__api__functions.html#gabc74705f034cd89fa8de16e93e223119" title="The function returns the local link layer device role which is connected to peer device with connecti...">Cy_BLE_GetDeviceRole(cy_stc_ble_conn_handle_t *connHandle)</a> function to discover the role of the link-layer device connected to a peer device with the connection handle indicated by the connHandle parameter. Write attributes (characteristic, descriptors) requests from the peer device(s) for adopted services (e.g. BAS, HIDS, HRS, etc) handled by the BLE Middleware.</p>
<p>For the Custom service, write attributes requests handled by the application level in the AppCallback () callback event function. The following code shows the handling of the Write operation by a peer device for the Custom service: </p><div class="fragment"><div class="line"><span class="comment">/* Call the back event function to handle various events from the BLE Stack */</span></div><div class="line"><span class="keywordtype">void</span> AppCallback (uint32 event, <span class="keywordtype">void</span>* eventParam)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (event)</div><div class="line">    {</div><div class="line">    ...</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__group__ble__common__api__events.html#gga7c1ef7e6d246e0f3eb6c883e23d82b86aacf391a3ca29026b4b969a35a19879d3">CY_BLE_EVT_GATTS_WRITE_REQ</a>:</div><div class="line">        {</div><div class="line">            <a class="code" href="group__group__ble__common__api__gatt__definitions.html#ga840a7207c3fa1dd4e5d88f0bdfdceecb">cy_en_ble_gatt_err_code_t</a> gattErr;</div><div class="line">            <a class="code" href="structcy__stc__ble__gatt__write__param__t.html">cy_stc_ble_gatt_write_param_t</a> *writeParam = </div><div class="line">                (<a class="code" href="structcy__stc__ble__gatt__write__param__t.html">cy_stc_ble_gatt_write_param_t</a> *)eventParam;</div><div class="line"></div><div class="line">            <span class="comment">/* Store data in the database */</span></div><div class="line">            gattErr = <a class="code" href="group__group__ble__common__api__gatt__server__functions.html#ga83833a69e752df584bf934e657269b6b">Cy_BLE_GATTS_WriteAttributeValuePeer</a>(</div><div class="line">                       &amp;writeParam-&gt;<a class="code" href="structcy__stc__ble__gatt__write__param__t.html#a7926437b7b01816b49319d26f4cdd9a6">connHandle</a>, &amp;writeParam-&gt;<a class="code" href="structcy__stc__ble__gatt__write__param__t.html#a62ac2975d36edbb3490b4d5517bc6d37">handleValPair</a>);</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span>(gattErr != <a class="code" href="group__group__ble__common__api__gatt__definitions.html#gga840a7207c3fa1dd4e5d88f0bdfdceecba5e159f8de5d93311cfbb5d971b7c2190">CY_BLE_GATT_ERR_NONE</a>)</div><div class="line">            {</div><div class="line">                <span class="comment">/* Send an Error Response */</span></div><div class="line">                <a class="code" href="structcy__stc__ble__gatt__err__info__t.html">cy_stc_ble_gatt_err_info_t</a> errInfo =</div><div class="line">                {</div><div class="line">                    .<a class="code" href="structcy__stc__ble__gatt__err__info__t.html#a9174ff868ae764005940c2b87d272d6e">opCode</a>     = <a class="code" href="group__group__ble__common__api__gatt__definitions.html#ggae06f56cc034e0b31fd066f0a12e4324bab3dec0c4dba2fac8fa512b316a63bf4e">CY_BLE_GATT_WRITE_REQ</a>,</div><div class="line">                    .attrHandle = writeParam-&gt;<a class="code" href="structcy__stc__ble__gatt__write__param__t.html#a62ac2975d36edbb3490b4d5517bc6d37">handleValPair</a>.<a class="code" href="structcy__stc__ble__gatt__handle__value__pair__t.html#a7f93d681d87c18f5df2ae66377c0c36d">attrHandle</a>,</div><div class="line">                    .errorCode  = gattErr</div><div class="line">                };</div><div class="line">                <a class="code" href="group__group__ble__common__api__gatt__server__functions.html#ga144da11ae3b06cec1d3d52b669ce7882">Cy_BLE_GATTS_SendErrorRsp</a>(&amp;writeParam-&gt;<a class="code" href="structcy__stc__ble__gatt__write__param__t.html#a7926437b7b01816b49319d26f4cdd9a6">connHandle</a>, &amp;errInfo);</div><div class="line">            }</div><div class="line">     ...</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>The common MMMS usage are Multi-Master Single-Slave and Multi-Role when the BLE_PDL Component is configured in all the GAP roles (Central, Peripheral, Observer, and Broadcaster).</p>
<p><b>Multi-Master Single-Slave Usage Block Diagram</b>  <style>div.image img[src="ble_multi_master_single_slave_usage_block_diagram.png"]{width:732;}</style>  </p><div class="image">
<img src="ble_multi_master_single_slave_usage_block_diagram.png" alt="ble_multi_master_single_slave_usage_block_diagram.png"/>
</div>
<p><b>Multi-Role Usage Block Diagram</b>  <style>div.image img[src="ble_multi_role_usage_block_diagram.png"]{width:726;}</style>  </p><div class="image">
<img src="ble_multi_role_usage_block_diagram.png" alt="ble_multi_role_usage_block_diagram.png"/>
</div>
<p>Refer to code examples CE215118_BLE_Multi_Master_Single_Slave and CE215555_BLE_Multi_Role for more details.</p>
<h1><a class="anchor" id="group_ble_interrupt_notify"></a>
BLE Interrupt Notification Callback</h1>
<p>The BLE Middleware exposes BLE interrupt notifications to the application which indicates a different link layer and radio state transitions to the user from the BLESS interrupt context. The user registers for a particular type of a callback and the BLE component will call that registered callback basing on the registered mask (Refer to the <a class="el" href="group__group__ble__common__api__functions.html#ga4f1bb36b7bd9cd99410c677a62da061e" title="This function registers a callback to expose BLE interrupt notifications to an application that indic...">Cy_BLE_RegisterInterruptCallback()</a> and <a class="el" href="group__group__ble__common__api__functions.html#ga9d1d62eec83ccdad2828712553359db8" title="This function un-registers callback which exposed BLE interrupt notifications to the application...">Cy_BLE_UnRegisterInterruptCallback()</a> APIs). All interrupts masks are specified in the <a class="el" href="group__group__ble__common__api__definitions.html#ga716607fd63ab34c49af7a84e76239640">cy_en_ble_interrupt_callback_feature_t</a> enumeration.</p>
<p>The possible interrupts which can trigger a user callback:</p><ol type="1">
<li><b>CY_BLE_INTR_CALLBACK_BLESS_STACK_ISR</b> - Executed on every trigger of the BLESS interrupt.</li>
<li><b>CY_BLE_INTR_CALLBACK_BLESS_INTR_STAT_DSM_EXITED</b> - Executed when the BLESS exits deep sleep mode and enters Active mode. A BLESS deep sleep exit can be triggered automatically by link layer hardware or by different BLE_PDL data transfer APIs, which needs the BLESS to be active.</li>
<li><b>CY_BLE_INTR_CALLBACK_BLELL_CONN_EXT_INTR_EARLY</b> - Executed when the BLESS connection engine in Slave mode detects a BLE packet that matches its access address.</li>
<li><b>CY_BLE_INTR_CALLBACK_BLELL_CONN_INTR_CE_RX</b> - Executed when the BLESS connection engine receives a non-empty packet from the peer device</li>
<li><b>CY_BLE_INTR_CALLBACK_BLELL_CONN_INTR_CE_TX_ACK</b> - Executed when the BLESS connection engine receives an ACK packet from the peer device for the previously transmitted packet.</li>
<li><b>CY_BLE_INTR_CALLBACK_BLELL_CONN_INTR_CLOSE_CE</b> - Executed when the BLESS connection engine closes the connection event. This interrupt is executed on every connection interval for connection, irrespective of data tx/rx state.</li>
<li><b>CY_BLE_INTR_CALLBACK_BLESS_INTR_STAT_DSM_ENTERED</b> - Executed when the BLESS enters deep sleep mode. A user call to the Cy_SysPm_DeepSleep() function will trigger the BLESS deep sleep entry sequence. A time instance when each of these interrupts (#1 to #7) are triggered in a connection event are shown below (green).</li>
<li><b>CY_BLE_INTR_CALLBACK_BLELL_SCAN_INTR_ADV_RX</b> - Executed when the BLESS scan engine receives an advertisement packet from the peer device.</li>
<li><b>CY_BLE_INTR_CALLBACK_BLELL_SCAN_INTR_SCAN_RSP_RX</b> - Executed when the BLESS scan engine receives a scan response packet from the peer device in response to a scan request from the scanner.</li>
<li><b>CY_BLE_INTR_CALLBACK_BLELL_ADV_INTR_CONN_REQ_RX</b> - Executed when the BLESS advertisement engine receives a connection request from the peer central device. An application can use these interrupt callbacks to know when the RF activity is about to begin/end or when the BLE device changes its state from advertisement to connected, or when the BLESS transitions between active and low-power modes, etc. These BLESS real-tie states can be used to synchronize an application with the BLESS or prevent radio interference with other peripherals etc.</li>
</ol>
<div class="image">
<img src="ble_intr_notify_feature.png" alt="ble_intr_notify_feature.png"/>
</div>
<p>This feature is enabled via define CY_BLE_INTR_NOTIFY_FEATURE_ENABLE in cy_ble_config.h. <br />
 </p><div class="fragment"><div class="line"><span class="preprocessor">#define CY_BLE_INTR_NOTIFY_FEATURE_ENABLE (1u)  //1u - Enable / 0u - Disable</span></div></div><!-- fragment --><p>BLE Dual mode requires an additional define IPC channel and IPC Interrupt structure to send notifications from the controller core to the host core. Use the following defines:<br />
 </p><div class="fragment"><div class="line"><span class="preprocessor">#define CY_BLE_INTR_NOTIFY_IPC_CHAN       (15u) // valid range:9..15, default:15</span></div><div class="line"><span class="preprocessor">#define CY_BLE_INTR_NOTIFY_IPC_INTR       (15u) // valid range:9..15, default:15</span></div><div class="line"><span class="preprocessor">#define CY_BLE_INTR_NOTIFY_IPC_INTR_PRIOR (1u)  // valid range:0..7,  default:1</span></div></div><!-- fragment --><h1><a class="anchor" id="group_ble_unsupported_features"></a>
Unsupported Features</h1>
<p>The BLE Middleware stack does not support the following optional Bluetooth v5.0 protocol features, as listed in Vol 6, Part B, section 4.6 of the specification:</p><ul>
<li>Connection Parameters Request Procedure (Vol 6, Part B, section 4.6.2)</li>
<li>Extended Reject Indication (Vol 6, Part B, section 4.6.3)</li>
<li>Slave-initiated Features Exchange (Vol 6, Part B, section 4.6.4)</li>
<li>Stable Modulation Index - Transmitter (Vol 6, Part B, section 4.6.10)</li>
<li>Stable Modulation Index - Receiver (Vol 6, Part B, section 4.6.11)</li>
<li>LE Extended Advertising (Vol 6, Part B, section 4.6.12)</li>
<li>LE Periodic Advertising (Vol 6, Part B, section 4.6.13)</li>
<li>Channel Selection Algorithm #2 (Vol 6, Part B, section 4.6.14)</li>
<li>Minimum Number of Used Channels Procedure (Vol 6, Part B, section 4.6.15)</li>
</ul>
<h1><a class="anchor" id="group_ble_lpm"></a>
Low-power Modes</h1>
<p>The BLE middleware automatically registers sleep and deep sleep callback functions. This functions requests the BLE Stack to put Bluetooth Low Energy Sub-System (BLESS) to low-power mode.</p>
<h1><a class="anchor" id="group_ble_io_connections"></a>
External PA/LNA Support</h1>
<p>RF front ends come in a variety of combinations. The most popular and comprehensive RF front ends come with a built-in power amplifier (PA) in the transmit path, a low-noise amplifier (LNA) in the receive path, a transmit/receive bypass path to bypass both the PA and LNA, and RF switches to select between transmit, receive, and bypass paths. Some front ends support multiple antennas. Some front ends have a built-in low-pass filter after the power amplifier. The discrete front ends also have almost the same configuration.</p>
<div class="image">
<img src="ble_ext_pa_lna_control.png" alt="ble_ext_pa_lna_control.png"/>
</div>
<h2><a class="anchor" id="group_ble_pa_lna_en"></a>
Chip Enable Signal</h2>
<p>This signal is needed to put the front end to sleep or in standby whenever there is no radio activity. The signal is ON when either PA control or LNA control is ON.</p>
<p>The polarity of this signal is configurable and can be set in the EXT_PA_LNA_CTRL register by <a class="el" href="group__group__ble__common__api__functions.html#ga0a3e12b0378b1a40083a591d18d9d9dd" title="This function controls the external Power Amplifier and Low Noise Amplifier outputs. ">Cy_BLE_ConfigureExtPA()</a> API.</p>
<h2><a class="anchor" id="group_ble_pa_tx_en"></a>
Tx ENABLE</h2>
<p>This signal is turned ON during transmission and turned OFF when not transmitting. This signal is active a little earlier than the actual start of transmission to allow for the time it takes for the Power amplifier to ramp up. This delay can be set in the EXT_PA_LNA_DLY_CNFG register.</p>
<p>The polarity of this signal is configurable and can be set in the EXT_PA_LNA_CTRL register by <a class="el" href="group__group__ble__common__api__functions.html#ga0a3e12b0378b1a40083a591d18d9d9dd" title="This function controls the external Power Amplifier and Low Noise Amplifier outputs. ">Cy_BLE_ConfigureExtPA()</a> API.</p>
<h2><a class="anchor" id="group_ble_lna_rx_en"></a>
Rx ENABLE</h2>
<p>This signal is needed to choose between the bypass path and the LNA path. This signal is ON during reception and OFF when the receiver is OFF. The polarity of this signal is configurable and can be set in the EXT_PA_LNA_CTRL register by <a class="el" href="group__group__ble__common__api__functions.html#ga0a3e12b0378b1a40083a591d18d9d9dd" title="This function controls the external Power Amplifier and Low Noise Amplifier outputs. ">Cy_BLE_ConfigureExtPA()</a> API. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part
<div id="nav-path" class="navpath">
    <ul>
        <li class="footer">
            Generated for <b>Cypress BLE Middleware Library</b> by <b>Cypress Semiconductor Corporation</b>.
            All rights reserved.
        </li>
    </ul>
</div>
-->
</body>
</html>
